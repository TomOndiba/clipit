(function(d){var i={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",excludeCurrent:false,excludeCurrentParameter:"x",prePopulate:null,processPrePopulate:false,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&#215;",animateDropdown:true,placeholder:null,theme:null,zindex:999,resultsLimit:null,enableHTML:false,resultsFormatter:function(l){var k=l[this.propertyToSearch];return"<li>"+(this.enableHTML?k:a(k))+"</li>"},tokenFormatter:function(l){var k=l[this.propertyToSearch];return"<li><p>"+(this.enableHTML?k:a(k))+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,tokenValue:"id",allowFreeTagging:false,allowTabOut:false,onResult:null,onCachedResult:null,onAdd:null,onFreeTaggingAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:false};var f={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"};var h={BEFORE:0,AFTER:1,END:2};var e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};var j={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};var g=/[&<>"'\/]/g;function c(k){return String((k===null||k===undefined)?"":k)}function a(k){return c(k).replace(g,function(l){return j[l]})}var b={init:function(k,l){var m=d.extend({},i,l||{});return this.each(function(){d(this).data("settings",m);d(this).data("tokenInputObject",new d.TokenList(this,k,m))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(k){this.data("tokenInputObject").add(k);return this},remove:function(k){this.data("tokenInputObject").remove(k);return this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(k){this.data("tokenInputObject").toggleDisabled(k);return this},setOptions:function(k){d(this).data("settings",d.extend({},d(this).data("settings"),k||{}));return this},destroy:function(){if(this.data("tokenInputObject")){this.data("tokenInputObject").destroy();this.siblings().remove();this.show()}return this}};d.fn.tokenInput=function(k){if(b[k]){return b[k].apply(this,Array.prototype.slice.call(arguments,1))}else{return b.init.apply(this,arguments)}};d.TokenList=function(o,y,aa){if(d.type(y)==="string"||d.type(y)==="function"){d(o).data("settings").url=y;var s=D();if(d(o).data("settings").crossDomain===undefined&&typeof s==="string"){if(s.indexOf("://")===-1){d(o).data("settings").crossDomain=false}else{d(o).data("settings").crossDomain=(location.href.split(/\/+/g)[1]!==s.split(/\/+/g)[1])}}}else{if(typeof(y)==="object"){d(o).data("settings").local_data=y}}if(d(o).data("settings").classes){d(o).data("settings").classes=d.extend({},f,d(o).data("settings").classes)}else{if(d(o).data("settings").theme){d(o).data("settings").classes={};d.each(f,function(ag,ah){d(o).data("settings").classes[ag]=ah+"-"+d(o).data("settings").theme})}else{d(o).data("settings").classes=f}}var M=[];var B=0;var x=new d.TokenList.Cache();var Y;var U;var G=d('<input type="text"  autocomplete="off" autocapitalize="off"/>').css({outline:"none"}).attr("id",d(o).data("settings").idPrefix+o.id).focus(function(){if(d(o).data("settings").disabled){return false}else{if(d(o).data("settings").tokenLimit===null||d(o).data("settings").tokenLimit!==B){r()}}v.addClass(d(o).data("settings").classes.focused)}).blur(function(){N();if(d(o).data("settings").allowFreeTagging){n()}d(this).val("");v.removeClass(d(o).data("settings").classes.focused)}).bind("keyup keydown blur update",l).keydown(function(ah){var aj;var ag;switch(ah.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!d(this).val()){aj=t.prev();ag=t.next();if((aj.length&&aj.get(0)===K)||(ag.length&&ag.get(0)===K)){if(ah.keyCode===e.LEFT||ah.keyCode===e.UP){R(d(K),h.BEFORE)}else{R(d(K),h.AFTER)}}else{if((ah.keyCode===e.LEFT||ah.keyCode===e.UP)&&aj.length){ab(d(aj.get(0)))}else{if((ah.keyCode===e.RIGHT||ah.keyCode===e.DOWN)&&ag.length){ab(d(ag.get(0)))}}}}else{var ai=null;if(ah.keyCode===e.DOWN||ah.keyCode===e.RIGHT){ai=d(W).next()}else{ai=d(W).prev()}if(ai.length){ae(ai)}}return false;break;case e.BACKSPACE:aj=t.prev();if(!d(this).val().length){if(K){q(d(K));L.change()}else{if(aj.length){ab(d(aj.get(0)))}}return false}else{if(d(this).val().length===1){N()}else{setTimeout(function(){J()},5)}}break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(W){T(d(W).data("tokeninput"));L.change()}else{if(d(o).data("settings").allowFreeTagging){if(d(o).data("settings").allowTabOut&&d(this).val()===""){return true}else{n()}}else{d(this).val("");if(d(o).data("settings").allowTabOut){return true}}ah.stopPropagation();ah.preventDefault()}return false;case e.ESCAPE:N();return true;default:if(String.fromCharCode(ah.which)){setTimeout(function(){J()},5)}break}});if(aa.placeholder){G.attr("placeholder",aa.placeholder)}var L=d(o).hide().val("").focus(function(){af(G)}).blur(function(){G.blur();return L});var K=null;var O=0;var W=null;var v=d("<ul />").addClass(d(o).data("settings").classes.tokenList).click(function(ah){var ag=d(ah.target).closest("li");if(ag&&ag.get(0)&&d.data(ag.get(0),"tokeninput")){ad(ag)}else{if(K){R(d(K),h.END)}af(G)}}).mouseover(function(ah){var ag=d(ah.target).closest("li");if(ag&&K!==this){ag.addClass(d(o).data("settings").classes.highlightedToken)}}).mouseout(function(ah){var ag=d(ah.target).closest("li");if(ag&&K!==this){ag.removeClass(d(o).data("settings").classes.highlightedToken)}}).insertBefore(L);var t=d("<li />").addClass(d(o).data("settings").classes.inputToken).appendTo(v).append(G);var ac=d("<div/>").addClass(d(o).data("settings").classes.dropdown).appendTo("body").hide();var S=d("<tester/>").insertAfter(G).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:G.css("fontSize"),fontFamily:G.css("fontFamily"),fontWeight:G.css("fontWeight"),letterSpacing:G.css("letterSpacing"),whiteSpace:"nowrap"});L.val("");var F=d(o).data("settings").prePopulate||L.data("pre");if(d(o).data("settings").processPrePopulate&&d.isFunction(d(o).data("settings").onResult)){F=d(o).data("settings").onResult.call(L,F)}if(F&&F.length){d.each(F,function(ag,ah){p(ah);P();G.attr("placeholder",null)})}if(d(o).data("settings").disabled){I(true)}if(d.isFunction(d(o).data("settings").onReady)){d(o).data("settings").onReady.call()}this.clear=function(){v.children("li").each(function(){if(d(this).children("input").length===0){q(d(this))}})};this.add=function(ag){T(ag)};this.remove=function(ag){v.children("li").each(function(){if(d(this).children("input").length===0){var aj=d(this).data("tokeninput");var ah=true;for(var ai in ag){if(ag[ai]!==aj[ai]){ah=false;break}}if(ah){q(d(this))}}})};this.getTokens=function(){return M};this.toggleDisabled=function(ag){I(ag)};this.destroy=function(){this.clear();ac.remove()};l();function k(ag){return d(o).data("settings").enableHTML?ag:a(ag)}function I(ag){if(typeof ag==="boolean"){d(o).data("settings").disabled=ag}else{d(o).data("settings").disabled=!d(o).data("settings").disabled}G.attr("disabled",d(o).data("settings").disabled);v.toggleClass(d(o).data("settings").classes.disabled,d(o).data("settings").disabled);if(K){R(d(K),h.END)}L.attr("disabled",d(o).data("settings").disabled)}function P(){if(d(o).data("settings").tokenLimit!==null&&B>=d(o).data("settings").tokenLimit){G.hide();N();return}}function l(){if(U===(U=G.val())){return}var ag=v.width()-G.offset().left-v.offset().left;S.html(a(U)||a(aa.placeholder));G.width(Math.min(v.width(),Math.max(ag,S.width()+30)))}function Z(ag){return((ag>=48&&ag<=90)||(ag>=96&&ag<=111)||(ag>=186&&ag<=192)||(ag>=219&&ag<=222))}function n(){var ag=d.trim(G.val());var ah=ag.split(d(o).data("settings").tokenDelimiter);d.each(ah,function(ak,aj){if(!aj){return}if(d.isFunction(d(o).data("settings").onFreeTaggingAdd)){aj=d(o).data("settings").onFreeTaggingAdd.call(L,aj)}var ai={};ai[d(o).data("settings").tokenValue]=ai[d(o).data("settings").propertyToSearch]=aj;T(ai)})}function p(ah){var aj=d(d(o).data("settings").tokenFormatter(ah));var ag=ah.readonly===true?true:false;if(ag){aj.addClass(d(o).data("settings").classes.tokenReadOnly)}aj.addClass(d(o).data("settings").classes.token).insertBefore(t);if(!ag){d("<span>"+d(o).data("settings").deleteText+"</span>").addClass(d(o).data("settings").classes.tokenDelete).appendTo(aj).click(function(){if(!d(o).data("settings").disabled){q(d(this).parent());L.change();return false}})}var ai=ah;d.data(aj.get(0),"tokeninput",ah);M=M.slice(0,O).concat([ai]).concat(M.slice(O));O++;C(M,L);B+=1;if(d(o).data("settings").tokenLimit!==null&&B>=d(o).data("settings").tokenLimit){G.hide();N()}return aj}function T(ag){var ai=d(o).data("settings").onAdd;if(B>0&&d(o).data("settings").preventDuplicates){var ah=null;v.children().each(function(){var ak=d(this);var aj=d.data(ak.get(0),"tokeninput");if(aj&&aj[aa.tokenValue]===ag[aa.tokenValue]){ah=ak;return false}});if(ah){ab(ah);t.insertAfter(ah);af(G);return}}G.width(1);if(d(o).data("settings").tokenLimit==null||B<d(o).data("settings").tokenLimit){p(ag);G.attr("placeholder",null);P()}G.val("");N();if(d.isFunction(ai)){ai.call(L,ag)}}function ab(ag){if(!d(o).data("settings").disabled){ag.addClass(d(o).data("settings").classes.selectedToken);K=ag.get(0);G.val("");N()}}function R(ah,ag){ah.removeClass(d(o).data("settings").classes.selectedToken);K=null;if(ag===h.BEFORE){t.insertBefore(ah);O--}else{if(ag===h.AFTER){t.insertAfter(ah);O++}else{t.appendTo(v);O=B}}af(G)}function ad(ah){var ag=K;if(K){R(d(K),h.END)}if(ag===ah.get(0)){R(ah,h.END)}else{ab(ah)}}function q(ah){var ai=d.data(ah.get(0),"tokeninput");var aj=d(o).data("settings").onDelete;var ag=ah.prevAll().length;if(ag>O){ag--}ah.remove();K=null;af(G);M=M.slice(0,ag).concat(M.slice(ag+1));if(M.length==0){G.attr("placeholder",aa.placeholder)}if(ag<O){O--}C(M,L);B-=1;if(d(o).data("settings").tokenLimit!==null){G.show().val("");af(G)}if(d.isFunction(aj)){aj.call(L,ai)}}function C(ai,ag){var ah=d.map(ai,function(aj){if(typeof d(o).data("settings").tokenValue=="function"){return d(o).data("settings").tokenValue.call(this,aj)}return aj[d(o).data("settings").tokenValue]});ag.val(ah.join(d(o).data("settings").tokenDelimiter))}function N(){ac.hide().empty();W=null}function w(){ac.css({position:"absolute",top:v.offset().top+v.outerHeight(),left:v.offset().left,width:v.width(),"z-index":d(o).data("settings").zindex}).show()}function u(){if(d(o).data("settings").searchingText){ac.html("<p>"+k(d(o).data("settings").searchingText)+"</p>");w()}}function r(){if(d(o).data("settings").hintText){ac.html("<p>"+k(d(o).data("settings").hintText)+"</p>");w()}}var Q=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g");function X(ag){return ag.replace(Q,"\\$&")}function A(ah,ag){return ah.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+X(ag)+")(?![^<>]*>)(?![^&;]+;)","gi"),function(ai,aj){return"<b>"+k(aj)+"</b>"})}function H(ah,ai,ag){return ah.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+X(ai)+")(?![^<>]*>)(?![^&;]+;)","g"),A(ai,ag))}function E(ah){if(d(o).data("settings").excludeCurrent){var ai=d(o).data("tokenInputObject").getTokens(),ag=[];if(ai.length){d.each(ah,function(aj,al){var ak=true;d.each(ai,function(am,an){if(al[d(o).data("settings").propertyToSearch]==an[d(o).data("settings").propertyToSearch]){ak=false;return false}});if(ak){ag.push(al)}});ah=ag}}return ah}function V(ai,ag){ag=E(ag);if(ag&&ag.length){ac.empty();var ah=d("<ul/>").appendTo(ac).mouseover(function(aj){ae(d(aj.target).closest("li"))}).mousedown(function(aj){T(d(aj.target).closest("li").data("tokeninput"));L.change();return false}).hide();if(d(o).data("settings").resultsLimit&&ag.length>d(o).data("settings").resultsLimit){ag=ag.slice(0,d(o).data("settings").resultsLimit)}d.each(ag,function(aj,ak){var al=d(o).data("settings").resultsFormatter(ak);al=H(al,ak[d(o).data("settings").propertyToSearch],ai);al=d(al).appendTo(ah);if(aj%2){al.addClass(d(o).data("settings").classes.dropdownItem)}else{al.addClass(d(o).data("settings").classes.dropdownItem2)}if(aj===0){ae(al)}d.data(al.get(0),"tokeninput",ak)});w();if(d(o).data("settings").animateDropdown){ah.slideDown("fast")}else{ah.show()}}else{if(d(o).data("settings").noResultsText){ac.html("<p>"+k(d(o).data("settings").noResultsText)+"</p>");w()}}}function ae(ag){if(ag){if(W){m(d(W))}ag.addClass(d(o).data("settings").classes.selectedDropdownItem);W=ag.get(0)}}function m(ag){ag.removeClass(d(o).data("settings").classes.selectedDropdownItem);W=null}function J(){var ag=G.val();if(ag&&ag.length){if(K){R(d(K),h.AFTER)}if(ag.length>=d(o).data("settings").minChars){u();clearTimeout(Y);Y=setTimeout(function(){z(ag)},d(o).data("settings").searchDelay)}else{N()}}}function z(an){var ai=an+D();var ap=x.get(ai);if(ap){if(d.isFunction(d(o).data("settings").onCachedResult)){ap=d(o).data("settings").onCachedResult.call(L,ap)}V(an,ap)}else{if(d(o).data("settings").url){var ag=D();var am={};am.data={};if(ag.indexOf("?")>-1){var ak=ag.split("?");am.url=ak[0];var aj=ak[1].split("&");d.each(aj,function(aq,at){var ar=at.split("=");am.data[ar[0]]=ar[1]})}else{am.url=ag}am.data[d(o).data("settings").queryParam]=an;am.type=d(o).data("settings").method;am.dataType=d(o).data("settings").contentType;if(d(o).data("settings").crossDomain){am.dataType="jsonp"}if(d(o).data("settings").excludeCurrent){var ah=d(o).data("tokenInputObject").getTokens();var ao=d.map(ah,function(aq){if(typeof d(o).data("settings").tokenValue=="function"){return d(o).data("settings").tokenValue.call(this,aq)}return aq[d(o).data("settings").tokenValue]});am.data[d(o).data("settings").excludeCurrentParameter]=ao.join(d(o).data("settings").tokenDelimiter)}am.success=function(aq){x.add(ai,d(o).data("settings").jsonContainer?aq[d(o).data("settings").jsonContainer]:aq);if(d.isFunction(d(o).data("settings").onResult)){aq=d(o).data("settings").onResult.call(L,aq)}if(G.val()===an){V(an,d(o).data("settings").jsonContainer?aq[d(o).data("settings").jsonContainer]:aq)}};if(aa.onSend){aa.onSend(am)}d.ajax(am)}else{if(d(o).data("settings").local_data){var al=d.grep(d(o).data("settings").local_data,function(aq){return aq[d(o).data("settings").propertyToSearch].toLowerCase().indexOf(an.toLowerCase())>-1});x.add(ai,al);if(d.isFunction(d(o).data("settings").onResult)){al=d(o).data("settings").onResult.call(L,al)}V(an,al)}}}}function D(){var ag=d(o).data("settings").url;if(typeof d(o).data("settings").url=="function"){ag=d(o).data("settings").url.call(d(o).data("settings"))}return ag}function af(ag){setTimeout(function(){ag.focus()},50)}};d.TokenList.Cache=function(l){var n=d.extend({max_size:500},l);var o={};var m=0;var k=function(){o={};m=0};this.add=function(q,p){if(m>n.max_size){k()}if(!o[q]){m+=1}o[q]=p};this.get=function(p){return o[p]}}}(jQuery));