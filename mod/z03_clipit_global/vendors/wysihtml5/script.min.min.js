var getCaretPixelPos=function(y,z,A){z=z||0;A=A||0;var e=0,w=0;if(y){e=y.offsetLeft;w=y.offsetTop;w=$(y).offset().top;w=w-$(".elgg-layout-one-sidebar .elgg-main").offset().top}var q={left:0,top:0};if(document.selection){var u=document.selection.createRange();q.left=u.offsetLeft+z-e+"px";q.top=u.offsetTop+A-w+"px"}else{if(window.getSelection){var v=y.contentDocument||y.contentWindow.document;var x=v.getSelection();var u=x.getRangeAt(0).cloneRange();try{u.setStart(u.startContainer,u.startOffset-1)}catch(t){}var r=u.getBoundingClientRect();if(u.endOffset==0||u.toString()===""){if(u.startContainer==y){if(u.endOffset==0){q.top="0px";q.left="0px"}else{var p=u.cloneRange();p.setStart(p.startContainer,0);var s=p.getBoundingClientRect();q.left=s.left+z-e+"px";q.top=s.top+s.height+A-w+"px"}}else{q.top=u.startContainer.offsetTop+"px";q.left=u.startContainer.offsetLeft+"px"}}else{q.left=r.left+r.width+z+e+"px";q.top=r.top+A+w+30+"px"}}}return q};function getTextAreaXandY(w){if(w.which==37){return}var t=$(this).getSelection();var x=t.start;$(this).blur();$("div").text($(this).val());$(this).setSelection(x,x+1);currentcharacter=$(this).getSelection().text;$(this).setSelection(x-1,x);previouscharacter=$(this).getSelection().text;var E,e;var C=0;var z=rangy.createRange();var s=previouscharacter.match(/(\r\n|\n|\r)/gm)==undefined?false:true;if(previouscharacter==" "||currentcharacter==" "||s){i=x+1;while(e!=" "&&C<$(this).val().length){i++;$(this).setSelection(i,i+1);var D=$(this).getSelection();e=D.text;C=D.start}z.setStart($("div")[0].childNodes[0],x);z.setEnd($("div")[0].childNodes[0],C);var u=z.toHtml();z.deleteContents();var A=$("<span id='nextword'>"+u+"</span>")[0];z.insertNode(A);var F=$("#nextword").position().top}z.setStart($("div")[0].childNodes[0],x);var v=$("<span id='caret'></span>")[0];z.insertNode(v);var B=$("#caret").position().top;if(previouscharacter==" "){z.setStart($("div")[0].childNodes[0],x-1);z.setEnd($("div")[0].childNodes[0],x);var y=$("<span id='prevchar'></span>")[0];z.insertNode(y);var G=$("#prevchar").position().top}$(this).focus();$(this).setSelection(t.start,t.end);if(G!=undefined&&G!=F){$("label").text("X: "+$("#nextword").position().left+"px, Y: "+$("#nextword").position().top);$("ul").css("left",($("#nextword").position().left)+"px");$("ul").css("top",($("#nextword").position().top+13)+"px")}else{$("label").text("X: "+$("#caret").position().left+"px, Y: "+$("#caret").position().top);$("ul").css("left",($("#caret").position().left)+"px");$("ul").css("top",($("#caret").position().top+14)+"px")}$("ul").css("display","block")}var AutoComplete_wysihtml5=function(e,f,d){this.editor=e;this.wysihtmlEditor=f,this.options=$.extend({},{source:[],delay:500,queryBy:"name",items:10},d);this.matcher=this.options.matcher||this.matcher;this.renderDropdown=this.options.renderDropdown||this.renderDropdown;this.render=this.options.render||this.render;this.insert=this.options.insert||this.insert;this.highlighter=this.options.highlighter||this.highlighter;this.query="";this.hasFocus=true;this.renderInput()};AutoComplete_wysihtml5.prototype={constructor:AutoComplete_wysihtml5,renderInput:function(){var b='<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext"><span class="dummy">\uFEFF</span></span></span>';this.editor.focus()},rteKeyUp:function(c){switch(c.which||c.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:if(this.query===""){this.cleanUp(true)}else{this.lookup()}break;case 9:case 13:var d=(this.$dropdown!==undefined)?this.$dropdown.find("li.active"):[];if(d.length){this.select(d.data());this.cleanUp(false)}else{this.cleanUp(true)}break;case 27:this.cleanUp(true);break;default:this.lookup()}},rteKeyDown:function(b){switch(b.which||b.keyCode){case 9:case 13:case 27:b.preventDefault();break;case 38:b.preventDefault();if(this.$dropdown!==undefined){this.highlightPreviousResult()}break;case 40:b.preventDefault();if(this.$dropdown!==undefined){this.highlightNextResult()}break}b.stopPropagation()},rteClicked:function(c){var d=$(c.target);if(this.hasFocus&&d.parent().attr("id")!=="autocomplete-searchtext"){this.cleanUp(true)}},rteLostFocus:function(d,c){if(this.hasFocus){this.cleanUp(true)}},lookup:function(){this.query=$.trim($(this.editor.getBody()).find("#autocomplete-searchtext").text()).replace("\ufeff","");if(this.$dropdown===undefined){this.show()}clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout($.proxy(function(){var b=$.isFunction(this.options.source)?this.options.source(this.query,$.proxy(this.process,this),this.options.delimiter):this.options.source;if(b){this.process(b)}},this),this.options.delay)},matcher:function(b){return ~b[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(k){var j=[],f=[],g=[],h;while((h=k.shift())!==undefined){if(!h[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())){j.push(h)}else{if(~h[this.options.queryBy].indexOf(this.query)){f.push(h)}else{g.push(h)}}}return j.concat(f,g)},highlighter:function(b){return b.replace(new RegExp("("+this.query+")","ig"),function(a,d){return"<strong>"+d+"</strong>"})},show:function(){var h=$(this.editor.getContainer()).offset(),g=$(this.editor.getContentAreaContainer()).position(),j=$(this.editor.dom.select("span#autocomplete")).position(),k=h.top+g.top+j.top+$(this.editor.selection.getNode()).innerHeight()-$(this.editor.getDoc()).scrollTop()+5,f=h.left+g.left+j.left;this.$dropdown=$(this.renderDropdown()).css({top:k,left:f});$("body").append(this.$dropdown);this.$dropdown.on("click",$.proxy(this.autoCompleteClick,this))},process:function(h){if(!this.hasFocus){return}var g=this,f=[],e=$.grep(h,function(a){return g.matcher(a)});e=g.sorter(e);e=e.slice(0,this.options.items);$.each(e,function(b,a){var c=$(g.render(a));c.html(c.html().replace(c.text(),g.highlighter(c.text())));$.each(e[b],function(k,d){c.attr("data-"+k,d)});f.push(c[0].outerHTML)});if(f.length){this.$dropdown.html(f.join("")).show()}else{this.$dropdown.hide()}},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(b){return'<li><a href="javascript:;"><span>'+b.name+"</span></a></li>"},autoCompleteClick:function(c){var d=$(c.target).closest("li").data();if(!$.isEmptyObject(d)){this.select(d);this.cleanUp(false)}c.stopPropagation();c.preventDefault()},highlightPreviousResult:function(){var d=this.$dropdown.find("li.active").index(),c=(d===0)?this.$dropdown.find("li").length-1:--d;this.$dropdown.find("li").removeClass("active").eq(c).addClass("active")},highlightNextResult:function(){var d=this.$dropdown.find("li.active").index(),c=(d===this.$dropdown.find("li").length-1)?0:++d;this.$dropdown.find("li").removeClass("active").eq(c).addClass("active")},select:function(c){this.editor.focus();var d=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(d);this.editor.execCommand("mceInsertContent",false,this.insert(c)+"&nbsp;")},insert:function(b){return"<span>"+b.name+"</span>"},cleanUp:function(f){this.hasFocus=false;if(this.$dropdown!==undefined){this.$dropdown.remove();delete this.$dropdown}if(f){var h=this.query,g=$(this.editor.dom.select("span#autocomplete")),j=$("<p>"+this.options.delimiter+h+"</p>")[0].firstChild,k=$(this.editor.selection.getNode()).offset().top===(g.offset().top+((g.outerHeight()-g.height())/2));this.editor.dom.replace(j,g[0]);if(k){this.editor.selection.select(j);this.editor.selection.collapse()}}}};