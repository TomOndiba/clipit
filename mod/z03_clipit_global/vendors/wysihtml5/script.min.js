var getCaretPixelPos=function(c,b,a){b=b||0;a=a||0;var o=0,f=0;if(c){o=c.offsetLeft;f=c.offsetTop;f=$(c).offset().top;f=f-$(".elgg-layout-one-sidebar .elgg-main").offset().top}var m={left:0,top:0};if(document.selection){var h=document.selection.createRange();m.left=h.offsetLeft+b-o+"px";m.top=h.offsetTop+a-f+"px"}else{if(window.getSelection){var g=c.contentDocument||c.contentWindow.document;var d=g.getSelection();var h=d.getRangeAt(0).cloneRange();try{h.setStart(h.startContainer,h.startOffset-1)}catch(j){}var l=h.getBoundingClientRect();if(h.endOffset==0||h.toString()===""){if(h.startContainer==c){if(h.endOffset==0){m.top="0px";m.left="0px"}else{var n=h.cloneRange();n.setStart(n.startContainer,0);var k=n.getBoundingClientRect();m.left=k.left+b-o+"px";m.top=k.top+k.height+a-f+"px"}}else{m.top=h.startContainer.offsetTop+"px";m.left=h.startContainer.offsetLeft+"px"}}else{m.left=l.left+l.width+b+o+"px";m.top=l.top+a+f+30+"px"}}}return m};function getTextAreaXandY(m){if(m.which==37){return}var p=$(this).getSelection();var l=p.start;$(this).blur();$("div").text($(this).val());$(this).setSelection(l,l+1);currentcharacter=$(this).getSelection().text;$(this).setSelection(l-1,l);previouscharacter=$(this).getSelection().text;var c,r;var f=0;var j=rangy.createRange();var q=previouscharacter.match(/(\r\n|\n|\r)/gm)==undefined?false:true;if(previouscharacter==" "||currentcharacter==" "||q){i=l+1;while(r!=" "&&f<$(this).val().length){i++;$(this).setSelection(i,i+1);var d=$(this).getSelection();r=d.text;f=d.start}j.setStart($("div")[0].childNodes[0],l);j.setEnd($("div")[0].childNodes[0],f);var o=j.toHtml();j.deleteContents();var h=$("<span id='nextword'>"+o+"</span>")[0];j.insertNode(h);var b=$("#nextword").position().top}j.setStart($("div")[0].childNodes[0],l);var n=$("<span id='caret'></span>")[0];j.insertNode(n);var g=$("#caret").position().top;if(previouscharacter==" "){j.setStart($("div")[0].childNodes[0],l-1);j.setEnd($("div")[0].childNodes[0],l);var k=$("<span id='prevchar'></span>")[0];j.insertNode(k);var a=$("#prevchar").position().top}$(this).focus();$(this).setSelection(p.start,p.end);if(a!=undefined&&a!=b){$("label").text("X: "+$("#nextword").position().left+"px, Y: "+$("#nextword").position().top);$("ul").css("left",($("#nextword").position().left)+"px");$("ul").css("top",($("#nextword").position().top+13)+"px")}else{$("label").text("X: "+$("#caret").position().left+"px, Y: "+$("#caret").position().top);$("ul").css("left",($("#caret").position().left)+"px");$("ul").css("top",($("#caret").position().top+14)+"px")}$("ul").css("display","block")}var AutoComplete_wysihtml5=function(a,c,b){this.editor=a;this.wysihtmlEditor=c,this.options=$.extend({},{source:[],delay:500,queryBy:"name",items:10},b);this.matcher=this.options.matcher||this.matcher;this.renderDropdown=this.options.renderDropdown||this.renderDropdown;this.render=this.options.render||this.render;this.insert=this.options.insert||this.insert;this.highlighter=this.options.highlighter||this.highlighter;this.query="";this.hasFocus=true;this.renderInput()};AutoComplete_wysihtml5.prototype={constructor:AutoComplete_wysihtml5,renderInput:function(){var a='<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext"><span class="dummy">\uFEFF</span></span></span>';this.editor.focus()},rteKeyUp:function(b){switch(b.which||b.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:if(this.query===""){this.cleanUp(true)}else{this.lookup()}break;case 9:case 13:var a=(this.$dropdown!==undefined)?this.$dropdown.find("li.active"):[];if(a.length){this.select(a.data());this.cleanUp(false)}else{this.cleanUp(true)}break;case 27:this.cleanUp(true);break;default:this.lookup()}},rteKeyDown:function(a){switch(a.which||a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:a.preventDefault();if(this.$dropdown!==undefined){this.highlightPreviousResult()}break;case 40:a.preventDefault();if(this.$dropdown!==undefined){this.highlightNextResult()}break}a.stopPropagation()},rteClicked:function(b){var a=$(b.target);if(this.hasFocus&&a.parent().attr("id")!=="autocomplete-searchtext"){this.cleanUp(true)}},rteLostFocus:function(a,b){if(this.hasFocus){this.cleanUp(true)}},lookup:function(){this.query=$.trim($(this.editor.getBody()).find("#autocomplete-searchtext").text()).replace("\ufeff","");if(this.$dropdown===undefined){this.show()}clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout($.proxy(function(){var a=$.isFunction(this.options.source)?this.options.source(this.query,$.proxy(this.process,this),this.options.delimiter):this.options.source;if(a){this.process(a)}},this),this.options.delay)},matcher:function(a){return ~a[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(c){var d=[],b=[],a=[],e;while((e=c.shift())!==undefined){if(!e[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())){d.push(e)}else{if(~e[this.options.queryBy].indexOf(this.query)){b.push(e)}else{a.push(e)}}}return d.concat(b,a)},highlighter:function(a){return a.replace(new RegExp("("+this.query+")","ig"),function(b,c){return"<strong>"+c+"</strong>"})},show:function(){var e=$(this.editor.getContainer()).offset(),a=$(this.editor.getContentAreaContainer()).position(),d=$(this.editor.dom.select("span#autocomplete")).position(),c=e.top+a.top+d.top+$(this.editor.selection.getNode()).innerHeight()-$(this.editor.getDoc()).scrollTop()+5,b=e.left+a.left+d.left;this.$dropdown=$(this.renderDropdown()).css({top:c,left:b});$("body").append(this.$dropdown);this.$dropdown.on("click",$.proxy(this.autoCompleteClick,this))},process:function(c){if(!this.hasFocus){return}var d=this,a=[],b=$.grep(c,function(e){return d.matcher(e)});b=d.sorter(b);b=b.slice(0,this.options.items);$.each(b,function(f,g){var e=$(d.render(g));e.html(e.html().replace(e.text(),d.highlighter(e.text())));$.each(b[f],function(h,j){e.attr("data-"+h,j)});a.push(e[0].outerHTML)});if(a.length){this.$dropdown.html(a.join("")).show()}else{this.$dropdown.hide()}},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(a){return'<li><a href="javascript:;"><span>'+a.name+"</span></a></li>"},autoCompleteClick:function(b){var a=$(b.target).closest("li").data();if(!$.isEmptyObject(a)){this.select(a);this.cleanUp(false)}b.stopPropagation();b.preventDefault()},highlightPreviousResult:function(){var a=this.$dropdown.find("li.active").index(),b=(a===0)?this.$dropdown.find("li").length-1:--a;this.$dropdown.find("li").removeClass("active").eq(b).addClass("active")},highlightNextResult:function(){var a=this.$dropdown.find("li.active").index(),b=(a===this.$dropdown.find("li").length-1)?0:++a;this.$dropdown.find("li").removeClass("active").eq(b).addClass("active")},select:function(b){this.editor.focus();var a=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(a);this.editor.execCommand("mceInsertContent",false,this.insert(b)+"&nbsp;")},insert:function(a){return"<span>"+a.name+"</span>"},cleanUp:function(b){this.hasFocus=false;if(this.$dropdown!==undefined){this.$dropdown.remove();delete this.$dropdown}if(b){var e=this.query,a=$(this.editor.dom.select("span#autocomplete")),d=$("<p>"+this.options.delimiter+e+"</p>")[0].firstChild,c=$(this.editor.selection.getNode()).offset().top===(a.offset().top+((a.outerHeight()-a.height())/2));this.editor.dom.replace(d,a[0]);if(c){this.editor.selection.select(d);this.editor.selection.collapse()}}}};